{# vi: set ft=sls : #}
x509_signing_policies:
{%- for cluster in k8s_salt_clusters %}
  {%- for ca in k8s_salt_cas %}
    {%- if ca == 'etcd-peer-ca' %}
      {%- set constraint = 'I@k8s_salt:roles:etcd' %}
    {%- elif ca == 'etcd-server-ca' %}
      {%- set constraint = 'I@k8s_salt:roles:etcd' %}
    {%- elif ca == 'etcd-trusted-ca' %}
      {%- set constraint = 'I@k8s_salt:roles:controlplane' %}
    {%- elif ca == 'requestheader-ca' %}
      {%- set constraint = 'I@k8s_salt:roles:controlplane' %}
    {%- elif ca == 'kube-ca' %}
      {%- set constraint = 'I@k8s_salt:roles:controlplane or I@k8s_salt:roles:worker' %}
    {%- endif %}
  {{ cluster }}_{{ ca }}:
  - minions: "I@k8s_salt:enabled:True and I@k8s_salt:cluster:{{ cluster }} and ( {{ constraint }} )"
  - signing_private_key: /etc/kubernetes-authority/{{ cluster }}/{{ ca }}-key.pem
  - signing_cert: /etc/kubernetes-authority/{{ cluster }}/{{ ca }}.pem
  - basicConstraints: "critical CA:false"
  - keyUsage: "critical keyEncipherment"
  - subjectKeyIdentifier: hash
  - authorityKeyIdentifier: keyid,issuer:always
  - copypath: /etc/pki/issued_certs/
  {% endfor %}
{% endfor %}
